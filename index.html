<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Struk Pembelian ELECPAY</title>

  <style>
    body {
      font-family: "Roboto Mono", monospace;
      background: #f2f2f2;
      padding: 20px;
    }
    .controls {
      max-width: 400px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    }
    .controls h2 { margin: 0 0 16px; font-size: 18px; }
    .controls label { display:block; margin:10px 0 4px; font-size:13px; }
    .controls input, .controls select {
      width:100%;
      padding:8px 10px;
      font-family: inherit;
      border:1px solid #ddd;
      border-radius:6px;
      font-size:14px;
    }
    .controls button {
      margin-top: 16px;
      width:100%;
      padding:12px;
      border:none;
      border-radius:6px;
      background:#1d72f3;
      color:white;
      font-weight:bold;
      cursor:pointer;
    }
    .hidden { display: none; }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="controls">
    <h2>ELECPAY</h2>
    <h2>Isi Data Struk</h2>
    <label for="trxid">TRXID</label>
    <input id="trxid" placeholder="">

    <label for="produk">PRODUK</label>
    <select id="produk">
      <option value="" selected disabled>-- Pilih Produk --</option>
      <option value="PULSA">PULSA</option>
      <option value="TOP UP">TOP UP</option>
      <option value="LISTRIK">LISTRIK</option>
    </select>

    <label for="nominal">NOMINAL</label>
    <div id="nominal-container">
      <input id="nominal" placeholder="">
    </div>

    <!-- Sub opsi khusus listrik -->
    <div id="sub-listrik" class="hidden">
      <label for="jenisListrik">Jenis Listrik</label>
      <select id="jenisListrik">
        <option value="" selected disabled>-- Pilih Jenis Listrik --</option>
        <option value="TOKEN">TOKEN</option>
        <option value="NON TOKEN">NON TOKEN</option>
      </select>
    </div>

    <label for="nomor">NOMOR/ID</label>
    <input id="nomor" placeholder="">

    <label for="harga">HARGA</label>
    <input id="harga" placeholder="">

    <button id="downloadPdf">Download PDF</button>
    <button id="shareWa">Share ke WA</button>
  </div>

<div id="strukPreview" style="display:none; background:#fff; padding:15px; border:1px dashed #333;">
  <h1 style="text-align:center;">ELECPAY</h1>
  <h3 style="text-align:center;">STRUK PEMBELIAN</h3>
  <p id="p-waktu" style="text-align:center;"></p> <!-- Tambah waktu -->
  <p id="p-trxid" ></p>
  <p id="p-produk"></p>
  <p id="p-nominal"></p>
  <p id="p-jenis"></p>
  <p id="p-nomor"></p>
  <p id="p-harga"></p>
  <hr>
  <p style="text-align:center;">SIMPAN STRUK INI SEBAGAI</p>
  <p style="text-align:center;">BUKTI PEMBELIAN SAH</p>
</div>

  <script>
    const nominalContainer = document.getElementById("nominal-container");
    const produkSelect = document.getElementById("produk");
    const hargaInput = document.getElementById("harga");
    const subListrik = document.getElementById("sub-listrik");
    const jenisListrikSelect = document.getElementById("jenisListrik");
    const nomorInput = document.getElementById("nomor");

    function updateNominalField() {
      if (produkSelect.value === "PULSA") {
        subListrik.classList.add("hidden");
        nominalContainer.innerHTML = `
          <select id="nominal">
            <option value="" selected disabled>-- Pilih Nominal --</option>
            <option value="5000">5.000</option>
            <option value="10000">10.000</option>
            <option value="15000">15.000</option>
            <option value="20000">20.000</option>
            <option value="25000">25.000</option>
            <option value="30000">30.000</option>
            <option value="40000">40.000</option>
            <option value="50000">50.000</option>
            <option value="60000">60.000</option>
            <option value="70000">70.000</option>
            <option value="80000">80.000</option>
            <option value="90000">90.000</option>
            <option value="100000">100.000</option>
          </select>
        `;
        document.getElementById("nominal").addEventListener("change", () => {
          const val = parseInt(document.getElementById("nominal").value);
          if (!isNaN(val)) {
            hargaInput.value = (val + 3000).toLocaleString("id-ID");
          } else {
            hargaInput.value = "";
          }
        });
      } else if (produkSelect.value === "TOP UP") {
        subListrik.classList.add("hidden");
        nominalContainer.innerHTML = `
          <select id="nominal">
            <option value="" selected disabled>-- Pilih Nominal --</option>
            <option value="50000">50.000</option>
            <option value="100000">100.000</option>
            <option value="150000">150.000</option>
            <option value="200000">200.000</option>
            <option value="250000">250.000</option>
            <option value="300000">300.000</option>
            <option value="350000">350.000</option>
            <option value="400000">400.000</option>
            <option value="450000">450.000</option>
            <option value="500000">500.000</option>
          </select>
        `;
        
                // Hitung harga dengan laba 5000
        document.getElementById("nominal").addEventListener("change", () => {
          const val = parseInt(document.getElementById("nominal").value);
          if (!isNaN(val)) {
            hargaInput.value = (val + 5000).toLocaleString("id-ID"); 
          } else {
            hargaInput.value = "";
          }
        });
        
        hargaInput.value = "";
      } else if (produkSelect.value === "LISTRIK") {
        subListrik.classList.remove("hidden");
        nominalContainer.innerHTML = `<input id="nominal" placeholder="">`;
        hargaInput.value = "";
      } else {
        subListrik.classList.add("hidden");
        nominalContainer.innerHTML = `<input id="nominal" placeholder=" ">`;
        hargaInput.value = "";
      }
    }
    
    

    // Event perubahan jenis listrik
    jenisListrikSelect.addEventListener("change", () => {
      const jenis = jenisListrikSelect.value;

      if (jenis === "TOKEN") {
        nominalContainer.innerHTML = `
          <select id="nominal">
            <option value="" selected disabled>-- Pilih Nominal --</option>
            <option value="20000">20.000</option>
            <option value="50000">50.000</option>
            <option value="100000">100.000</option>
            <option value="200000">200.000</option>
            <option value="500000">500.000</option>
            <option value="1000000">1.000.000</option>
          </select>
        `;

        // Hitung harga dengan laba 2000
        document.getElementById("nominal").addEventListener("change", () => {
          const val = parseInt(document.getElementById("nominal").value);
          if (!isNaN(val)) {
            hargaInput.value = (val + 2000).toLocaleString("id-ID"); 
          } else {
            hargaInput.value = "";
          }
        });

        // Format nomor/id pakai "-" setiap 4 digit
        nomorInput.addEventListener("input", () => {
          let angka = nomorInput.value.replace(/[^0-9]/g, ""); // hanya angka
          let grup = angka.match(/.{1,4}/g); // potong per 4 digit
          nomorInput.value = grup ? grup.join("-") : "";
        });

      } else if (jenis === "NON TOKEN") {
  nominalContainer.innerHTML = `<input id="nominal" placeholder=" ">`;
  hargaInput.value = "";

  // Hitung harga
  document.getElementById("nominal").addEventListener("input", () => {
    let inputVal = document.getElementById("nominal").value;

    // kalau ada tanda +
    let nominalVal;
    if (inputVal.includes("+")) {
      let parts = inputVal.split("+").map(v => parseInt(v.trim()));
      if (parts.every(num => !isNaN(num))) {
        nominalVal = parts.reduce((a, b) => a + b, 0);
      } else {
        nominalVal = NaN;
      }
    } else {
      nominalVal = parseInt(inputVal.replace(/\./g, "").replace(/,/g, ""));
    }

    if (!isNaN(nominalVal)) {
      let harga = nominalVal + 1500;

      // --- LOGIKA PEMBULATAN KHUSUS ---
      // Ambil sisa pembagian dengan 500
      let sisa = harga % 500;

      if (sisa > 100) {
        // jika sisa lebih dari 100, naik ke kelipatan 500 berikutnya
        harga = Math.ceil(harga / 500) * 500;
      } else {
        // kalau tidak, turun ke kelipatan 500 bawah
        harga = Math.floor(harga / 500) * 500;
      }
      // --- END LOGIKA PEMBULATAN ---

      hargaInput.value = harga.toLocaleString("id-ID");
    } else {
      hargaInput.value = "";
    }
  });

  // Kembalikan input nomor/id normal (tanpa format strip)
  nomorInput.addEventListener("input", () => {
    nomorInput.value = nomorInput.value.replace(/[^0-9]/g, "");
  });
}
});

    produkSelect.addEventListener("change", updateNominalField);

    document.getElementById('downloadPdf').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: "mm", format: "a6" });

      const trxid   = document.getElementById('trxid').value || "-";
      const produk  = document.getElementById('produk').value || "-";
      const nominal = document.getElementById('nominal').value || "-";
      const nomor   = document.getElementById('nomor').value || "-";
      const harga   = document.getElementById('harga').value || "-";
      const jenis   = produk === "LISTRIK" ? (document.getElementById('jenisListrik').value || "-") : "-";

      const now = new Date();
      const ts = now.toLocaleDateString('id-ID') + " " + now.toLocaleTimeString('id-ID');

      pdf.setFont("courier", "normal");
      pdf.setFontSize(12);

      pdf.text("ELECPAY", 43, 15);
      pdf.text(ts, 30, 22);

      pdf.setFontSize(14);
      pdf.text("STRUK PEMBELIAN", 10, 35);

      pdf.setFontSize(12);
      pdf.text(`TRXID    : ${trxid}`, 10, 50);
      pdf.text(`PRODUK   : ${produk}`, 10, 55);
      pdf.text(`NOMINAL  : ${nominal}`, 10, 60);
      pdf.text(`JENIS    : ${jenis}`, 10, 65);
      pdf.text(`NOMOR/ID : ${nomor}`, 10, 70);
      pdf.text(`HARGA    : ${harga}`, 10, 75);

      pdf.text("SIMPAN STRUK INI SEBAGAI", 10, 90);
      pdf.text("BUKTI PEMBELIAN YANG SAH", 10, 95);

      pdf.save("struk-pembelian.pdf");
      
            // Nama file pakai tanggal
      const filename = `struk-${now.toISOString().replace(/[:.]/g,"-")}.pdf`;
      pdf.save(filename);
    });
    
    // Share ke WA Status (pakai gambar)
  document.getElementById('shareWa').addEventListener('click', async () => {
  const now = new Date();
  const waktu = now.toLocaleDateString("id-ID") + " " + now.toLocaleTimeString("id-ID");
  const tanggal = now.toLocaleDateString('id-ID').replace(/\//g, '-');
  const jam = now.toLocaleTimeString('id-ID').replace(/[:]/g, '-');

  // Buat nama file otomatis (misalnya: struk-2025-10-06_14-35-59.png)
  const trxid = document.getElementById("trxid").value || "TRX";
  const fileName = `struk-${trxid}-${tanggal}_${jam}.png`;

  // isi data ke struk preview
  document.getElementById("p-waktu").innerText  = " " + waktu;
  document.getElementById("p-trxid").innerText  = "TRXID   : " + (document.getElementById("trxid").value || "-");
  document.getElementById("p-produk").innerText = "PRODUK  : " + (document.getElementById("produk").value || "-");
  document.getElementById("p-nominal").innerText= "NOMINAL : " + (document.getElementById("nominal").value || "-");

  const produkSelect = document.getElementById("produk");
  if (produkSelect.value === "LISTRIK") {
    document.getElementById("p-jenis").innerText = "JENIS   : " + (document.getElementById("jenisListrik").value || "-");
  } else {
    document.getElementById("p-jenis").innerText = "";
  }

  document.getElementById("p-nomor").innerText  = "NOMOR   : " + (document.getElementById("nomor").value || "-");
  document.getElementById("p-harga").innerText  = "HARGA   : " + (document.getElementById("harga").value || "-");

  const struk = document.getElementById("strukPreview");
  struk.style.display = "block";

  const canvas = await html2canvas(struk);

  // ✅ Download otomatis dengan nama file unik
  const link = document.createElement("a");
  link.download = fileName;
  link.href = canvas.toDataURL("image/png");
  link.click();

  // ✅ Share ke WhatsApp
  canvas.toBlob(async (blob) => {
    const file = new File([blob], fileName, { type: "image/png" });

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      try {
        await navigator.share({
          files: [file],
          title: "Struk Pembelian",
          text: "Bukti Pembelian"
        });
      } catch (err) {
        alert("Gagal share: " + err);
      }
    } else {
      alert("Browser tidak mendukung share gambar langsung. Silakan upload manual ke WhatsApp.");
    }
  });
});
  </script>
</body>
</html>
</html>